<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Master v35 (Final Stable)</title>
    <style>
        :root {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b;
            --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.3); --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --border: #e2e8f0; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-primary: #f8fafc; --text-secondary: #94a3b8;
            --accent: #818cf8; --accent-glow: rgba(129, 140, 248, 0.3); --border: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family); -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-primary); transition: 0.3s; min-height: 100vh; padding: 20px 10px 100px 10px; overflow-x: hidden; }
        
        /* Focus Mode Handling */
        body.focus-active .header-card, body.focus-active .goals-wrapper, body.focus-active .graph-toggle, body.focus-active .settings-btn { display: none !important; }
        body.focus-active .container { max-width: 600px; margin-top: 10vh; }
        body.focus-active .sticky-wrapper { position: static; background: transparent !important; box-shadow: none !important; border: none; }

        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 24px; }
        
        .header-card { background: var(--bg-card); border-radius: 24px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        
        .settings-btn, .notif-btn { background: var(--bg-body); border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); }
        .graph-toggle { background: var(--bg-body); padding: 4px; border-radius: 12px; display: flex; gap: 4px; border: 1px solid var(--border); }
        .toggle-btn { padding: 6px 14px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; cursor: pointer; }
        .toggle-btn.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        .cloud-status { font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; margin-top: 4px; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text-secondary); }
        .status-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        .status-dot.success { background: var(--success); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .chart-wrapper { position: relative; height: 200px; width: 100%; border-bottom: 1px solid var(--border); display: flex; align-items: flex-end; }
        .chart-grid { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .grid-line { width: 100%; height: 1px; background: var(--border); opacity: 0.4; }
        .bars-container { display: flex; align-items: flex-end; justify-content: space-between; width: 100%; height: 100%; padding-top: 20px; z-index: 2; gap: 8px; }
        .bars-container.month-view { overflow-x: auto; justify-content: flex-start; gap: 10px; }
        
        .bar-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; min-width: 30px; cursor: pointer; }
        .bar-stack { width: 14px; border-radius: 4px; background: rgba(0,0,0,0.05); display: flex; flex-direction: column-reverse; overflow: hidden; min-height: 6px; transition: height 0.6s ease; }
        .bar-segment { width: 100%; transition: height 0.3s ease; }
        .bar-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px; font-weight: 700; }
        .count-label { font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 4px; opacity: 0; transform: translateY(5px); transition: 0.2s; font-family: monospace; }
        .bar-group:hover .count-label { opacity: 1; transform: translateY(0); }

        .sticky-wrapper { position: sticky; top: 0; z-index: 2000; background-color: var(--bg-body); padding: 15px 0; border-bottom: 1px solid var(--border); transition: background-color 0.3s; }
        .filter-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; overflow: hidden; }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .filter-chip { padding: 4px 12px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }

        .search-bar { background: var(--bg-card); padding: 10px; border-radius: 18px; display: flex; align-items: center; border: 1px solid var(--border); margin-bottom: 10px; }
        .main-input { flex: 1; border: none; background: transparent; font-size: 1rem; outline: none; color: var(--text-primary); padding-left: 10px; }
        .big-add-btn { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        
        .chips-row { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; scrollbar-width: none; }
        .chip { padding: 6px 12px; border-radius: 50px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .chip.active { background: var(--text-primary); color: var(--bg-card); }
        .chip.p-high.active { background: var(--danger); color: white !important; border-color: var(--danger); }
        .chip.p-med.active { background: #f59e0b; color: white !important; border-color: #f59e0b; }
        .chip.p-low.active { background: var(--success); color: white !important; border-color: var(--success); }

        .section-title { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; display: flex; justify-content: space-between; }
        .add-icon-btn { width: 28px; height: 28px; border-radius: 8px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        
        .goals-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .goal-column { background: var(--bg-card); border-radius: 20px; padding: 20px; border: 1px solid var(--border); }
        
        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 50px; }
        .task-card { background: var(--bg-card); padding: 14px; border-radius: 14px; border: 1px solid var(--border); display: flex; flex-direction: column; animation: slideUp 0.3s ease; position: relative; }
        .task-main-row { display: flex; align-items: center; gap: 12px; width: 100%; z-index: 2; }
        .goal-column .task-card { background: var(--bg-body); }
        
        .task-check { width: 24px; height: 24px; border: 2px solid var(--text-secondary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .task-check.checked { background: var(--success); border-color: var(--success); }
        .task-check.checked::after { content: '‚úì'; color: white; font-weight: 900; font-size: 14px; }
        
        .task-body { flex: 1; min-width: 0; }
        .task-txt { font-size: 1rem; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-txt.done { text-decoration: line-through; color: var(--text-secondary); opacity: 0.7; }
        .task-meta { display: flex; gap: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
        .meta-tag { padding: 2px 8px; border-radius: 4px; background: var(--bg-body); color: var(--text-secondary); border: 1px solid var(--border); }
        .p-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }

        .task-actions { display: flex; gap: 5px; opacity: 0.5; transition: 0.2s; }
        .task-card:hover .task-actions { opacity: 1; }
        .action-icon { cursor: pointer; padding: 6px; font-size: 1rem; color: var(--text-secondary); }
        .action-icon:hover { color: var(--accent); }
        .action-icon.del:hover { color: var(--danger); }

        .subtask-area { max-height: 0; overflow: hidden; transition: 0.3s; background: var(--bg-body); margin: 0 -14px -14px -14px; padding: 0 14px; }
        .subtask-area.active { max-height: 500px; padding-top: 10px; padding-bottom: 10px; border-top: 1px solid var(--border); }
        .sub-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-secondary); }
        .sub-check { width: 18px; height: 18px; border: 1px solid var(--text-secondary); border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; background: var(--bg-card); }
        .sub-check.checked { background: var(--accent); border-color: var(--accent); }
        .sub-check.checked::after { content: '‚úì'; color: white; font-size: 12px; }
        .sub-input-main { width: 100%; border: 1px solid var(--border); background: var(--bg-card); padding: 8px; border-radius: 8px; outline: none; color: var(--text-primary); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: var(--bg-card); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); }
        .modal-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-primary); margin-bottom: 15px; outline: none; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-base { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        .btn-confirm { background: var(--accent); color: white; }
        
        .sync-section { margin-top: 15px; border-top: 1px solid var(--border); padding-top: 15px; text-align: left; }
        .sync-input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-primary); margin-bottom: 10px; outline: none; font-family: monospace; font-size: 0.8rem; }
        
        .theme-fab { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; z-index: 100; }
        .focus-fab { position: fixed; bottom: 90px; right: 30px; width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 100; color: var(--accent); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .confetti { position: fixed; width: 8px; height: 8px; top: -10px; z-index: 3000; pointer-events: none; border-radius: 50%; }
        .drag-handle { cursor: move; color: var(--border); margin-right: 8px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header-card">
        <div class="header-top">
            <div>
                <h2 style="margin:0;">Dashboard</h2>
                <div style="font-size:0.9rem; color:var(--text-secondary); font-weight:600;" id="dateDisplay">...</div>
                <div class="cloud-status" id="cloudIndicator" style="display:none;">
                    <div class="status-dot" id="cloudDot"></div>
                    <span id="cloudText">Cloud Ready</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="graph-toggle">
                    <button class="toggle-btn active" id="btn-week" onclick="setGraph('week')">Week</button>
                    <button class="toggle-btn" id="btn-month" onclick="setGraph('month')">Month</button>
                </div>
                <button class="settings-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="chart-wrapper">
            <div class="chart-grid"><div class="grid-line"></div><div class="grid-line"></div><div class="grid-line"></div><div class="grid-line"></div><div class="grid-line"></div></div>
            <div class="bars-container" id="chartBars"></div>
        </div>
    </div>
    
    <div class="sticky-wrapper">
        <div class="filter-wrapper">
            <div style="font-size:0.7rem; font-weight:800; color:var(--text-secondary);">FILTER:</div>
            <div class="filter-scroll" id="filterContainer"></div>
        </div>
        <div class="search-bar">
            <input type="text" class="main-input" id="quick_add_input" placeholder="New Task..." autocomplete="off">
            <button class="big-add-btn" onclick="addTask('daily')">ADD</button>
        </div>
        <div class="chips-row">
            <div class="chip p-low active" onclick="setPriority(this, 'low')">Low</div>
            <div class="chip p-med" onclick="setPriority(this, 'med')">Medium</div>
            <div class="chip p-high" onclick="setPriority(this, 'high')">High</div>
        </div>
        <div class="chips-row">
            <button class="settings-btn" style="width:30px; height:30px;" onclick="openCatManager()">‚öôÔ∏è</button>
            <div id="catContainer" style="display:flex; gap:8px;"></div>
        </div>
    </div>

    <div>
        <div class="section-title">Today <span style="font-size:0.8em; opacity:0.5; font-weight:400" id="todayCount">0</span></div>
        <div class="task-list" id="taskListDaily" ondragover="handleDragOver(event)"></div>
    </div>
    
    <div class="goals-wrapper">
        <div class="goal-column"><div class="section-title"><span style="color:var(--accent)">Weekly</span><div class="add-icon-btn" onclick="openAddGoalModal('weekly')">Ôºã</div></div><div class="task-list" id="taskListWeekly"></div></div>
        <div class="goal-column"><div class="section-title"><span style="color:#ec4899">Monthly</span><div class="add-icon-btn" onclick="openAddGoalModal('monthly')">Ôºã</div></div><div class="task-list" id="taskListMonthly"></div></div>
    </div>
</div>

<div class="modal-overlay" id="rolloverModal"><div class="modal-card"><div class="modal-title">New Day!</div><div class="modal-subtitle">Pending tasks: <span id="rolloverCount" style="color:var(--danger)">0</span></div><div class="modal-btns"><button class="btn-base btn-confirm" onclick="handleRollover('transfer')">Transfer</button><button class="btn-base btn-cancel" onclick="handleRollover('archive')">Clear</button></div></div></div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-card">
        <div class="modal-title">Settings</div>
        <button class="btn-base btn-cancel" style="width:100%; margin-bottom:10px;" onclick="exportData()">Backup Data</button>
        <button class="btn-base btn-cancel" style="width:100%; margin-bottom:10px;" onclick="triggerImport()">Restore Data</button>
        <input type="file" id="importFile" hidden onchange="handleFileLoad(this)">
        <div class="sync-section">
            <div style="font-size:0.8rem; font-weight:700; margin-bottom:5px;">Firebase Config</div>
            <textarea class="sync-input" id="firebaseConfig" placeholder='{"apiKey": "..."}' style="height:60px;"></textarea>
            <input type="text" class="sync-input" id="syncId" placeholder="Secret ID">
            <button class="btn-base btn-confirm" onclick="initFirebase(true)">Sync Now</button>
        </div>
        <button class="btn-base btn-cancel" style="width:100%; margin-top:15px;" onclick="closeModal('settingsModal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="editTaskModal"><div class="modal-card"><div class="modal-title">Edit</div><input type="text" class="modal-input" id="editTaskTitle"><div class="modal-btns"><button class="btn-base btn-cancel" onclick="closeModal('editTaskModal')">Cancel</button><button class="btn-base btn-confirm" onclick="saveTaskEdit()">Save</button></div></div></div>
<div class="modal-overlay" id="addGoalModal"><div class="modal-card"><div class="modal-title" id="goalModalTitle">Add Goal</div><input type="text" class="modal-input" id="goalInputName"><div class="modal-btns"><button class="btn-base btn-cancel" onclick="closeModal('addGoalModal')">Cancel</button><button class="btn-base btn-confirm" id="btnSaveGoal">Save</button></div></div></div>
<div class="modal-overlay" id="catManagerModal"><div class="modal-card"><div class="modal-title">Categories</div><div id="catManagerList" style="text-align:left; margin-bottom:15px; max-height:200px; overflow-y:auto;"></div><button class="btn-base btn-confirm" onclick="promptAddCategory()">+ Add</button><button class="btn-base btn-cancel" style="margin-top:10px;" onclick="closeModal('catManagerModal')">Done</button></div></div>

<div class="toast-container" id="toastContainer"></div>
<button class="focus-fab" onclick="toggleFocusMode()">üéØ</button>
<button class="theme-fab" onclick="toggleTheme()">üåì</button>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // --- CORE STATE ---
    const KEY = 'tm_v35_store';
    let state = { todos: [], goals: { weekly: [], monthly: [] }, dailyStats: {}, categories: ['Personal', 'Work'], theme: 'light', graphMode: 'week', activeFilter: 'All' };
    let inputs = { priority: 'low', category: 'Personal' };
    let dbRef = null, syncTimer = null, editingId = null, editingType = null, rolloverTasks = [];
    let isSyncingDown = false; // The Loop Killer

    // --- INITIALIZATION ---
    function init() {
        const saved = localStorage.getItem(KEY);
        if(saved) state = { ...state, ...JSON.parse(saved) };
        
        // Data Integrity Fixes
        if(!state.dailyStats) state.dailyStats = {};
        ['todos','weekly','monthly'].forEach(k => { if(Array.isArray(state[k])) state[k].forEach(t => { if(!t.subtasks) t.subtasks=[]; }); else if(k!=='todos') state.goals[k]=[]; });

        // Load Sync Config
        const conf = JSON.parse(localStorage.getItem('tm_firebase_config') || '{}');
        if(conf.str) document.getElementById('firebaseConfig').value = conf.str;
        if(conf.id) document.getElementById('syncId').value = conf.id;

        // UI Setup
        document.documentElement.setAttribute('data-theme', state.theme);
        document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
        
        // Run Logic
        recalcStats();
        checkRollover();
        render();
        if(conf.str && conf.id) initFirebase(false);

        // Listeners
        document.addEventListener('keydown', e => { 
            if(e.key==='n' && e.target.tagName!=='INPUT') { e.preventDefault(); document.getElementById('quick_add_input').focus(); }
            if(e.key==='f' && e.target.tagName!=='INPUT') { e.preventDefault(); toggleFocusMode(); }
        });
    }

    // --- SYNC ENGINE (FIXED) ---
    function initFirebase(manual) {
        const str = document.getElementById('firebaseConfig').value.trim();
        const id = document.getElementById('syncId').value.trim();
        if(!str || !id) return;
        
        localStorage.setItem('tm_firebase_config', JSON.stringify({ str, id }));
        try {
            if(!firebase.apps.length) firebase.initializeApp(JSON.parse(str));
            dbRef = firebase.database().ref('tm_v35/' + id);
            
            updateCloudUI('syncing', 'Connecting...');
            
            // LISTENER: Trusts the cloud implicitly
            dbRef.on('value', snap => {
                const val = snap.val();
                if(val) {
                    isSyncingDown = true; // Block loop
                    state = val;
                    save(true); // Save to local without pushing back
                    recalcStats();
                    render();
                    updateCloudUI('success', 'Synced');
                    setTimeout(() => isSyncingDown = false, 500); // Release lock
                } else {
                    push(); // New cloud DB, push local
                }
            });
        } catch(e) { 
            if(manual) alert("Config Invalid"); 
            updateCloudUI('error', 'Error');
        }
    }

    function push() {
        if(!dbRef || isSyncingDown) return;
        updateCloudUI('syncing', 'Syncing...');
        dbRef.set(state).then(() => updateCloudUI('success', 'Saved')).catch(() => updateCloudUI('error', 'Error'));
    }

    function save(fromRemote = false) {
        localStorage.setItem(KEY, JSON.stringify(state));
        if(!fromRemote && dbRef && !isSyncingDown) {
            clearTimeout(syncTimer);
            syncTimer = setTimeout(push, 500); // 500ms debounce
        }
    }

    // --- LOGIC ---
    function recalcStats() {
        // Force calculation of today's stats based on actual tasks
        const k = new Date().toISOString().split('T')[0]; // Strict YYYY-MM-DD
        const t = state.todos;
        state.dailyStats[k] = { total: t.length, done: t.filter(x=>x.completed).length };
    }

    function addTask(type) {
        const el = type==='daily' ? document.getElementById('quick_add_input') : document.getElementById('goalInputName');
        const txt = el.value.trim();
        if(!txt) return;
        
        const task = { id: Date.now(), text: txt, priority: inputs.priority, category: inputs.category, completed: false, subtasks: [] };
        if(type==='daily') state.todos.push(task); else state.goals[type].push(task);
        
        el.value = '';
        if(type!=='daily') closeModal('addGoalModal');
        
        sortTasks(type==='daily' ? state.todos : state.goals[type]);
        recalcStats();
        save(); render();
    }

    function toggleTask(type, id) {
        const list = type==='daily' ? state.todos : state.goals[type];
        const t = list.find(x => x.id === id);
        if(t) {
            t.completed = !t.completed;
            if(t.completed) rainConfetti();
            recalcStats();
            save(); render();
        }
    }

    function checkRollover() {
        const today = new Date().toISOString().split('T')[0];
        if(state.lastDate && state.lastDate !== today) {
            const open = state.todos.filter(x => !x.completed);
            if(open.length > 0) {
                rolloverTasks = open;
                document.getElementById('rolloverCount').innerText = open.length;
                document.getElementById('rolloverModal').classList.add('active');
            }
            state.todos = []; // Clear for new day
        }
        state.lastDate = today;
        save();
    }

    function handleRollover(action) {
        if(action === 'transfer') {
            const fresh = rolloverTasks.map(t => ({...t, id: Date.now()+Math.random(), completed: false}));
            state.todos = [...fresh, ...state.todos];
            recalcStats();
        }
        document.getElementById('rolloverModal').classList.remove('active');
        save(); render();
    }

    // --- RENDERERS ---
    function render() {
        // Graph
        const c = document.getElementById('chartBars'); c.innerHTML = '';
        const limit = state.graphMode==='week' ? 7 : 30;
        c.className = state.graphMode==='month' ? 'bars-container month-view' : 'bars-container';
        
        for(let i=limit-1; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate() - i);
            const k = d.toISOString().split('T')[0];
            const stat = state.dailyStats[k] || {total:0, done:0};
            const h = stat.total ? (stat.done/stat.total)*100 : 0;
            const col = h===100 ? 'var(--success)' : (h>0 ? 'var(--accent)' : '#eee');
            c.innerHTML += `
            <div class="bar-group">
                <div class="count-label">${stat.done}/${stat.total}</div>
                <div class="bar-stack" style="height:100px"><div class="bar-segment" style="height:${Math.max(h,5)}%; background:${col}"></div></div>
                <div class="bar-label" style="${i===0?'color:var(--accent)':''}">${d.getDate()}</div>
            </div>`;
        }

        // Filters & Cats
        document.getElementById('filterContainer').innerHTML = ['All', ...state.categories].map(c => 
            `<div class="filter-chip ${state.activeFilter===c?'active':''}" onclick="state.activeFilter='${c}';render()">${c}</div>`).join('');
        document.getElementById('catContainer').innerHTML = state.categories.map(c => 
            `<div class="chip ${inputs.category===c?'active':''}" onclick="inputs.category='${c}';render()">${c}</div>`).join('');

        // Tasks
        renderList('daily', 'taskListDaily');
        renderList('weekly', 'taskListWeekly');
        renderList('monthly', 'taskListMonthly');
        document.getElementById('todayCount').innerText = state.todos.filter(x=>!x.completed).length;
    }

    function renderList(type, elId) {
        const el = document.getElementById(elId); el.innerHTML = '';
        let list = type==='daily' ? state.todos : state.goals[type];
        if(state.activeFilter !== 'All') list = list.filter(x => x.category === state.activeFilter);
        
        list.forEach(t => {
            const pCol = t.priority==='high'?'#ef4444':t.priority==='med'?'#f59e0b':'#10b981';
            const subs = t.subtasks.length ? `<span class="meta-tag">${t.subtasks.filter(x=>x.completed).length}/${t.subtasks.length}</span>` : '';
            
            el.innerHTML += `
            <div class="task-card" draggable="true" ondragstart="dragStart(event, ${t.id})" ondrop="drop(event, ${t.id}, '${type}')" ondragover="event.preventDefault()">
                <div class="task-main-row">
                    <div class="drag-handle">::</div>
                    <div class="task-check ${t.completed?'checked':''}" onclick="toggleTask('${type}', ${t.id})"></div>
                    <div class="task-body">
                        <div class="task-txt ${t.completed?'done':''}">${t.text}</div>
                        <div class="task-meta"><span class="p-dot" style="background:${pCol}"></span><span>${t.category}</span>${subs}</div>
                    </div>
                    <div class="task-actions">
                        <div class="action-icon" onclick="editTask('${type}', ${t.id})">‚úé</div>
                        <div class="action-icon" onclick="toggleSub(${t.id})">‚ñº</div>
                        <div class="action-icon del" onclick="delTask('${type}', ${t.id})">üóë</div>
                    </div>
                </div>
                <div class="subtask-area" id="sub-${t.id}">
                    ${t.subtasks.map((s,i) => `
                        <div class="sub-item">
                            <div class="sub-check ${s.completed?'checked':''}" onclick="togSub('${type}',${t.id},${i})"></div>
                            <div style="flex:1">${s.text}</div>
                            <div class="action-icon del" onclick="delSub('${type}',${t.id},${i})">√ó</div>
                        </div>`).join('')}
                    <input type="text" class="sub-input-main" placeholder="Add subtask..." onkeydown="if(event.key==='Enter') addSub(event,'${type}',${t.id})">
                </div>
            </div>`;
        });
    }

    // --- HELPERS ---
    function setPriority(el, p) { inputs.priority = p; render(); }
    function setGraph(m) { state.graphMode = m; render(); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function updateCloudUI(s, t) { document.getElementById('cloudIndicator').style.display='flex'; document.getElementById('cloudText').innerText=t; document.getElementById('cloudDot').className=`status-dot ${s}`; }
    function toggleFocusMode() { document.body.classList.toggle('focus-active'); }
    function toggleTheme() { state.theme = state.theme==='light'?'dark':'light'; init(); } // Re-init to apply
    function rainConfetti() { for(let i=0; i<20; i++){ const c = document.createElement('div'); c.className='confetti'; c.style.left=Math.random()*100+'vw'; c.style.background=i%2?'#6366f1':'#10b981'; document.body.appendChild(c); setTimeout(()=>c.remove(), 2000); } }

    // --- CRUD OPS ---
    function toggleSub(id) { document.getElementById(`sub-${id}`).classList.toggle('active'); }
    function addSub(e, type, id) { const t = (type==='daily'?state.todos:state.goals[type]).find(x=>x.id===id); t.subtasks.push({text:e.target.value, completed:false}); save(); render(); }
    function togSub(type, tid, idx) { const t = (type==='daily'?state.todos:state.goals[type]).find(x=>x.id===tid); t.subtasks[idx].completed = !t.subtasks[idx].completed; save(); render(); }
    function delSub(type, tid, idx) { const t = (type==='daily'?state.todos:state.goals[type]).find(x=>x.id===tid); t.subtasks.splice(idx,1); save(); render(); }
    function delTask(type, id) { if(!confirm('Delete?')) return; if(type==='daily') state.todos=state.todos.filter(x=>x.id!==id); else state.goals[type]=state.goals[type].filter(x=>x.id!==id); recalcStats(); save(); render(); }
    
    function editTask(type, id) { editingType=type; editingId=id; const t = (type==='daily'?state.todos:state.goals[type]).find(x=>x.id===id); document.getElementById('editTaskTitle').value = t.text; openModal('editTaskModal'); }
    function saveTaskEdit() { const t = (editingType==='daily'?state.todos:state.goals[editingType]).find(x=>x.id===editingId); t.text = document.getElementById('editTaskTitle').value; closeModal('editTaskModal'); save(); render(); }

    function openCatManager() { document.getElementById('catManagerList').innerHTML = state.categories.map((c,i) => `<div>${c} <span onclick="state.categories.splice(${i},1);save();openCatManager()">üóë</span></div>`).join(''); openModal('catManagerModal'); }
    function promptAddCategory() { const n = prompt('Name:'); if(n) { state.categories.push(n); save(); openCatManager(); render(); } }
    function openAddGoalModal(t) { document.getElementById('goalModalTitle').innerText = 'Add '+t; document.getElementById('btnSaveGoal').onclick = () => addTask(t); openModal('addGoalModal'); }

    // --- DRAG ---
    function sortTasks(l) { const m = {high:3, med:2, low:1}; l.sort((a,b) => m[b.priority] - m[a.priority]); }
    function dragStart(e, id) { e.dataTransfer.setData('text', id); }
    function drop(e, targetId, type) { e.preventDefault(); const srcId = parseInt(e.dataTransfer.getData('text')); const list = type==='daily'?state.todos:state.goals[type]; const srcIdx = list.findIndex(x=>x.id===srcId); const tgtIdx = list.findIndex(x=>x.id===targetId); if(srcIdx>-1 && tgtIdx>-1) { const [moved] = list.splice(srcIdx, 1); list.splice(tgtIdx, 0, moved); save(); render(); } }

    // --- EXPORT/IMPORT ---
    function exportData() { const a = document.createElement('a'); a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(state)); a.download = 'backup.json'; a.click(); }
    function triggerImport() { document.getElementById('importFile').click(); }
    function handleFileLoad(input) { const r = new FileReader(); r.onload = e => { state = JSON.parse(e.target.result); save(); location.reload(); }; r.readAsText(input.files[0]); }

    // Style for Confetti fall
    const s = document.createElement('style'); s.innerHTML = `@keyframes fall { to { transform: translateY(100vh) rotate(360deg); } } .confetti { animation: fall 2s linear forwards; }`; document.head.appendChild(s);

    init();
</script>
</body>
</html>
