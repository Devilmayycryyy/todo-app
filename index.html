<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Task Master v41 (Full + Sync Fix)</title>
    <style>
        :root {
            --bg-body: #f1f5f9; --bg-card: #ffffff; --text-primary: #1e293b; --text-secondary: #64748b;
            --accent: #6366f1; --accent-glow: rgba(99, 102, 241, 0.3); --danger: #ef4444; --success: #10b981;
            --warning: #f59e0b; --border: #e2e8f0; --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }
        [data-theme="dark"] {
            --bg-body: #0f172a; --bg-card: #1e293b; --text-primary: #f8fafc; --text-secondary: #94a3b8;
            --accent: #818cf8; --accent-glow: rgba(129, 140, 248, 0.3); --border: #334155;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: var(--font-family); -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s, color 0.3s; min-height: 100vh; padding: 20px 10px; padding-bottom: 100px; overflow-x: hidden; }

        /* HEADER & GRAPH */
        .container { max-width: 900px; margin: 0 auto; display: flex; flex-direction: column; gap: 24px; }
        .header-card { background: var(--bg-card); border-radius: 24px; padding: 24px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .settings-btn, .notif-btn { background: var(--bg-body); border: 1px solid var(--border); width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); transition: 0.2s; }
        .settings-btn:hover { background: var(--text-primary); color: var(--bg-card); }
        .graph-toggle { background: var(--bg-body); padding: 4px; border-radius: 12px; display: flex; gap: 4px; border: 1px solid var(--border); }
        .toggle-btn { padding: 6px 14px; border-radius: 8px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .toggle-btn.active { background: var(--bg-card); color: var(--accent); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .chart-wrapper { position: relative; height: 180px; width: 100%; border-bottom: 1px solid var(--border); display: flex; align-items: flex-end; }
        .chart-grid { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        .grid-line { width: 100%; height: 1px; background: var(--border); opacity: 0.4; }
        .bars-container { display: flex; align-items: flex-end; justify-content: space-between; width: 100%; height: 100%; padding-top: 20px; z-index: 2; gap: 8px; }
        .bar-group { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; flex: 1; cursor: pointer; min-width: 30px; }
        .bar-stack { width: 14px; border-radius: 4px; background: rgba(0,0,0,0.05); display: flex; flex-direction: column-reverse; overflow: hidden; min-height: 6px; transition: height 0.6s ease; }
        .bar-segment { width: 100%; transition: height 0.3s ease; }
        .bar-segment.done { background: var(--success); }
        .bar-segment.missed { background: var(--danger); opacity: 0.8; }
        .bar-segment.remaining { background: var(--border); }
        .bar-label { font-size: 0.7rem; color: var(--text-secondary); margin-top: 6px; font-weight: 700; text-align: center; }
        .count-label { font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 4px; font-family: monospace; font-weight: 600; opacity: 0; transform: translateY(5px); transition: 0.2s; }
        .bar-group:hover .count-label { opacity: 1; transform: translateY(0); }

        /* STATUS */
        .cloud-status { font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; margin-top: 4px; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-secondary); }
        .status-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        .status-dot.success { background: var(--success); }
        .status-dot.error { background: var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* STICKY BAR */
        .sticky-wrapper { position: sticky; top: 0; z-index: 100; background-color: var(--bg-body); padding: 15px 0; border-bottom: 1px solid var(--border); box-shadow: 0 10px 30px -15px rgba(0,0,0,0.1); }
        .filter-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; }
        .filter-chip { padding: 4px 12px; border-radius: 8px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; cursor: pointer; white-space: nowrap; }
        .filter-chip.active { background: var(--accent); color: white; border-color: var(--accent); }
        
        .search-bar { background: var(--bg-card); padding: 10px 10px 10px 20px; border-radius: 18px; display: flex; align-items: center; border: 1px solid var(--border); box-shadow: 0 4px 12px -2px rgba(0,0,0,0.05); margin-bottom: 10px; }
        .main-input { flex: 1; border: none; background: transparent; font-size: 1rem; outline: none; color: var(--text-primary); }
        .big-add-btn { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        
        .chips-row { display: flex; gap: 8px; overflow-x: auto; padding: 2px 0 8px 0; scrollbar-width: none; align-items: center; }
        .chip { padding: 6px 12px; border-radius: 50px; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); font-size: 0.8rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .chip.active { background: var(--text-primary); color: var(--bg-card); border-color: var(--text-primary); }
        .chip.p-high.active { background: var(--danger); border-color: var(--danger); color: white; }
        .chip.p-med.active { background: var(--warning); border-color: var(--warning); color: white; }
        .chip.p-low.active { background: var(--success); border-color: var(--success); color: white; }
        .manage-btn { width: 28px; height: 28px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* TASKS */
        .goals-wrapper { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; }
        .goal-column { background: var(--bg-card); border-radius: 20px; padding: 20px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        .section-title { font-size: 1.1rem; font-weight: 800; color: var(--text-primary); margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .add-icon-btn { width: 28px; height: 28px; border-radius: 8px; background: var(--accent); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; }

        .task-list { display: flex; flex-direction: column; gap: 10px; min-height: 50px; }
        .task-card { background: var(--bg-card); padding: 14px; border-radius: 14px; border: 1px solid var(--border); display: flex; flex-direction: column; animation: slideUp 0.3s ease; position: relative; overflow: hidden; }
        .task-main-row { display: flex; align-items: center; gap: 12px; width: 100%; position: relative; z-index: 2; }
        .task-check { width: 24px; height: 24px; border: 2px solid var(--text-secondary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s; }
        .task-check.checked { background: var(--success); border-color: var(--success); }
        .task-check.checked::after { content: '‚úì'; color: white; font-weight: 900; font-size: 14px; }
        
        .task-body { flex: 1; min-width: 0; }
        .task-txt { font-size: 1rem; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .task-txt.done { text-decoration: line-through; color: var(--text-secondary); opacity: 0.7; }
        .task-meta { display: flex; gap: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; align-items: center; flex-wrap: wrap; }
        .meta-tag { padding: 2px 8px; border-radius: 4px; background: var(--bg-body); color: var(--text-secondary); border: 1px solid var(--border); }
        .p-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }

        .task-actions { display: flex; gap: 2px; opacity: 0.5; transition: 0.2s; }
        .task-card:hover .task-actions { opacity: 1; }
        .action-icon { cursor: pointer; padding: 6px; font-size: 1rem; color: var(--text-secondary); border-radius: 6px; }
        .action-icon:hover { color: var(--accent); background: var(--bg-body); }
        .action-icon.del:hover { color: var(--danger); background: #fef2f2; }
        .chevron-icon { transition: transform 0.3s ease; }
        .chevron-icon.rotated { transform: rotate(180deg); }

        /* SUBTASKS */
        .subtask-area { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: var(--bg-body); margin: 0 -14px -14px -14px; padding: 0 14px; border-top: 1px solid transparent; }
        .subtask-area.active { max-height: 500px; padding-top: 10px; padding-bottom: 10px; border-top-color: var(--border); }
        .sub-progress { height: 4px; background: rgba(0,0,0,0.05); border-radius: 2px; margin-bottom: 12px; overflow: hidden; }
        .sub-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.3s; }
        .sub-item { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; margin-bottom: 8px; color: var(--text-secondary); padding-left: 5px; }
        .sub-check { width: 18px; height: 18px; border: 1px solid var(--text-secondary); border-radius: 6px; cursor: pointer; display: flex; justify-content: center; align-items: center; flex-shrink: 0; background: var(--bg-card); }
        .sub-check.checked { background: var(--accent); border-color: var(--accent); }
        .sub-check.checked::after { content: '‚úì'; color: white; font-size: 12px; }
        .sub-text { flex: 1; cursor: text; padding: 4px 6px; border-radius: 4px; }
        .sub-text:hover { background: var(--bg-card); }
        .sub-text-input { width: 100%; border: 1px solid var(--accent); border-radius: 4px; padding: 4px 6px; outline: none; background: var(--bg-card); color: var(--text-primary); }
        .sub-del { cursor: pointer; color: var(--danger); opacity: 0; }
        .sub-item:hover .sub-del { opacity: 1; }
        .sub-input-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .sub-input-main { flex: 1; border: 1px solid var(--border); background: var(--bg-card); padding: 8px 12px; border-radius: 8px; outline: none; color: var(--text-primary); }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 3000; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: var(--bg-card); padding: 25px; border-radius: 24px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--border); box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); transform: scale(0.9); transition: 0.3s; }
        .modal-overlay.active .modal-card { transform: scale(1); }
        .modal-title { font-size: 1.3rem; font-weight: 800; margin-bottom: 6px; }
        .modal-subtitle { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 20px; }
        .modal-input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-primary); outline: none; margin-bottom: 15px; }
        .modal-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-base { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }
        .btn-confirm { background: var(--accent); color: white; }
        .btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
        
        .theme-fab { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border); box-shadow: 0 10px 20px -5px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; z-index: 100; transition: 0.3s; }
        .toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 4000; pointer-events: none; }
        .toast { background: var(--text-primary); color: var(--bg-card); padding: 10px 20px; border-radius: 50px; font-weight: 600; font-size: 0.9rem; margin-top: 10px; opacity: 0; transform: translateY(20px); transition: 0.3s; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.3); }
        .toast.visible { opacity: 1; transform: translateY(0); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-card">
        <div class="header-top">
            <div>
                <h2 style="margin:0;">Dashboard</h2>
                <div style="font-size:0.9rem; color:var(--text-secondary); font-weight:600;" id="dateDisplay">...</div>
                <div class="cloud-status" id="cloudIndicator" style="display:none;">
                    <div class="status-dot" id="cloudDot"></div>
                    <span id="cloudText">Saved</span>
                </div>
            </div>
            <div class="header-actions">
                <div class="graph-toggle">
                    <button class="toggle-btn active" id="btn-week" onclick="setGraph('week')">Week</button>
                    <button class="toggle-btn" id="btn-month" onclick="setGraph('month')">Month</button>
                </div>
                <button class="settings-btn" onclick="openModal('settingsModal')">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="chart-wrapper">
            <div class="chart-grid"><div class="grid-line"></div><div class="grid-line"></div><div class="grid-line"></div><div class="grid-line"></div><div class="grid-line"></div></div>
            <div class="bars-container" id="chartBars"></div>
        </div>
    </div>
    
    <div class="sticky-wrapper">
        <div class="filter-wrapper">
            <div class="filter-scroll" id="filterContainer"></div>
        </div>
        <div class="search-bar">
            <input type="text" class="main-input" id="quick_add_input" placeholder="New Task..." onkeypress="if(event.key==='Enter') addTask('daily')">
            <button class="big-add-btn" onclick="addTask('daily')">ADD</button>
        </div>
        <div class="chips-row">
            <div class="chip p-low active" onclick="setPriority(this, 'low')">Low</div>
            <div class="chip p-med" onclick="setPriority(this, 'med')">Medium</div>
            <div class="chip p-high" onclick="setPriority(this, 'high')">High</div>
        </div>
        <div class="chips-row">
            <button class="manage-btn" onclick="openCatManager()">‚öôÔ∏è</button>
            <div id="catContainer" style="display:flex; gap:8px;"></div>
        </div>
    </div>

    <div>
        <div class="section-title">Today's Missions <span style="font-size:0.8em; opacity:0.5; font-weight:400" id="todayCount">0 tasks</span></div>
        <div class="task-list" id="taskListDaily"></div>
    </div>
    
    <div class="goals-wrapper">
        <div class="goal-column"><div class="section-title"><span style="color:var(--accent)">Weekly</span><div class="add-icon-btn" onclick="openAddGoalModal('weekly')">Ôºã</div></div><div class="task-list" id="taskListWeekly"></div></div>
        <div class="goal-column"><div class="section-title"><span style="color:#ec4899">Monthly</span><div class="add-icon-btn" onclick="openAddGoalModal('monthly')">Ôºã</div></div><div class="task-list" id="taskListMonthly"></div></div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-card">
        <div class="modal-title">Settings</div>
        <div class="modal-subtitle">Sync to Google Firebase</div>
        <div style="background:#f1f5f9; padding:10px; border-radius:8px; margin-bottom:15px; text-align:left;">
            <label style="font-size:0.7rem; font-weight:700;">Database URL:</label>
            <input type="text" id="firebaseUrlInput" class="modal-input" style="margin-bottom:0;" placeholder="https://your-app.firebaseio.com/">
        </div>
        <div class="modal-btns">
            <button class="btn-base btn-confirm" onclick="manualSync('upload')">Force Upload</button>
            <button class="btn-base btn-confirm" style="background:#0ea5e9" onclick="manualSync('download')">Force Download</button>
        </div>
        <div id="syncLog" style="font-size:0.65rem; color:var(--text-secondary); margin-top:10px; text-align:left; max-height:60px; overflow-y:auto; font-family:monospace;"></div>
        <button class="btn-base btn-cancel" style="width:100%; margin-top:15px;" onclick="closeModal('settingsModal')">Close</button>
    </div>
</div>

<div class="modal-overlay" id="editTaskModal">
    <div class="modal-card">
        <div class="modal-title">Edit Task</div>
        <input type="text" class="modal-input" id="editTaskTitle">
        <div class="chips-row" id="editPriorityChips" style="justify-content:center; margin-bottom:15px;"></div>
        <div class="chips-row" id="editCategoryChips" style="justify-content:center;"></div>
        <div class="modal-btns"><button class="btn-base btn-cancel" onclick="closeModal('editTaskModal')">Cancel</button><button class="btn-base btn-confirm" onclick="saveTaskEdit()">Save</button></div>
    </div>
</div>

<div class="modal-overlay" id="addGoalModal"><div class="modal-card"><div class="modal-title">Add Goal</div><input type="text" class="modal-input" id="goalInputName" placeholder="Goal Name..."><div class="modal-btns"><button class="btn-base btn-cancel" onclick="closeModal('addGoalModal')">Cancel</button><button class="btn-base btn-confirm" id="btnSaveGoal">Save</button></div></div></div>
<div class="modal-overlay" id="catManagerModal"><div class="modal-card"><div class="modal-title">Categories</div><div class="cat-list-ui" id="catManagerList"></div><button class="btn-base btn-confirm" style="width:100%; margin-top:10px;" onclick="promptAddCategory()">+ New</button><button class="btn-base btn-cancel" style="width:100%; margin-top:10px;" onclick="closeModal('catManagerModal')">Done</button></div></div>
<div class="modal-overlay" id="catInputModal"><div class="modal-card"><div class="modal-title">New Category</div><input type="text" class="modal-input" id="catInputField"><div class="modal-btns"><button class="btn-base btn-cancel" onclick="closeModal('catInputModal')">Cancel</button><button class="btn-base btn-confirm" id="catInputConfirm">Save</button></div></div></div>
<div class="modal-overlay" id="rolloverModal"><div class="modal-card"><div class="modal-title">Rollover</div><div class="modal-subtitle">Move <span id="rolloverCount">0</span> tasks to today?</div><div class="modal-btns"><button class="btn-base btn-confirm" onclick="handleRollover('transfer')">Yes</button><button class="btn-base btn-cancel" onclick="handleRollover('archive')">No, Archive</button></div></div></div>

<div class="toast-container" id="toastContainer"></div>
<button class="theme-fab" onclick="toggleTheme()">üåì</button>

<script>
    // --- STATE ---
    let state = { todos: [], goals: { weekly: [], monthly: [] }, archives: {}, categories: ['Personal', 'Work'], theme: 'light', graphMode: 'week', activeFilter: 'All', lastLoginDate: null, updatedAt: 0 };
    let currentInput = { priority: 'low', category: 'Personal' };
    let syncTimer = null;
    let autoSyncInterval = null;
    let editingTaskInfo = null;
    let pendingRolloverTasks = [];

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('tm_universal_store');
        if(saved) { try { state = JSON.parse(saved); } catch(e){} }
        
        // Defaults
        if(!state.categories || !state.categories.length) state.categories = ['Personal'];
        if(!state.goals) state.goals = { weekly: [], monthly: [] };
        if(!state.archives) state.archives = {};
        
        const url = localStorage.getItem('tm_firebase_url');
        if(url) {
            document.getElementById('firebaseUrlInput').value = url;
            document.getElementById('cloudIndicator').style.display = 'flex';
            startAutoSync();
            cloudDownload(true);
        }

        document.documentElement.setAttribute('data-theme', state.theme);
        document.getElementById('dateDisplay').innerText = new Date().toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
        
        checkDayRollover();
        renderAll();
        
        // Save on Exit/Hidden
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "hidden") cloudUpload(true);
            else if (document.visibilityState === "visible") cloudDownload(true);
        });
    }

    // --- SYNC ENGINE (v40 LOGIC) ---
    function startAutoSync() {
        if(autoSyncInterval) clearInterval(autoSyncInterval);
        autoSyncInterval = setInterval(() => cloudDownload(true), 8000);
    }

    async function cloudDownload(isSilent) {
        const url = getUrl();
        if(!url) return;
        if(!isSilent) updateStatus('syncing', 'Downloading...');

        try {
            const res = await fetch(`${url}data.json?t=${Date.now()}`);
            const remote = await res.json();
            
            if(remote) {
                // MERGE STATE
                if(remote.updatedAt > state.updatedAt) {
                    state.todos = mergeLists(state.todos, remote.todos);
                    state.goals.weekly = mergeLists(state.goals.weekly, remote.goals.weekly);
                    state.goals.monthly = mergeLists(state.goals.monthly, remote.goals.monthly);
                    state.categories = [...new Set([...state.categories, ...(remote.categories||[])])];
                    state.archives = { ...state.archives, ...(remote.archives||{}) };
                    state.updatedAt = remote.updatedAt;
                    
                    saveLocal();
                    if(!isSilent) log("‚úÖ Merged from Cloud");
                    updateStatus('success', 'Synced');
                } else if (state.updatedAt > remote.updatedAt) {
                    if(!isSilent) log("‚ÑπÔ∏è Local newer. Pushing...");
                    cloudUpload(true);
                } else {
                    updateStatus('success', 'Up to date');
                }
            } else {
                if(!isSilent) log("‚ö†Ô∏è Cloud empty. Initializing...");
                cloudUpload(true);
            }
        } catch(e) { updateStatus('error', 'Net Error'); }
    }

    async function cloudUpload(isSilent) {
        const url = getUrl();
        if(!url) return;
        if(!isSilent) updateStatus('syncing', 'Uploading...');
        
        try {
            await fetch(`${url}data.json`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(state),
                keepalive: true
            });
            updateStatus('success', 'Saved');
            if(!isSilent) log("‚úÖ Uploaded");
        } catch(e) { updateStatus('error', 'Save Failed'); }
    }

    function mergeLists(local, remote) {
        if(!remote) return local;
        const map = new Map();
        [...local, ...remote].forEach(t => {
            if(!map.has(t.id)) map.set(t.id, t);
            else {
                // Conflict: Prefer completed or newer
                const existing = map.get(t.id);
                if(t.completed && !existing.completed) map.set(t.id, t);
                else if (t.subtasks && t.subtasks.length > (existing.subtasks||[]).length) map.set(t.id, t);
            }
        });
        return Array.from(map.values()).sort((a,b) => b.id - a.id);
    }

    function getUrl() {
        let url = document.getElementById('firebaseUrlInput').value.trim();
        if(!url) url = localStorage.getItem('tm_firebase_url');
        if(url && !url.endsWith('/')) url += '/';
        return url;
    }

    function manualSync(action) {
        const url = document.getElementById('firebaseUrlInput').value.trim();
        if(url) {
            localStorage.setItem('tm_firebase_url', url);
            document.getElementById('cloudIndicator').style.display = 'flex';
            startAutoSync();
        }
        if(action === 'upload') cloudUpload(false);
        if(action === 'download') cloudDownload(false);
    }

    // --- CORE LOGIC ---
    function save() { 
        state.updatedAt = Date.now(); 
        saveLocal(); 
        cloudUpload(true); 
    }
    function saveLocal() { 
        localStorage.setItem('tm_universal_store', JSON.stringify(state)); 
        renderAll(); 
    }

    function addTask(type) {
        let text, priority, category;
        if(type === 'daily') {
            const input = document.getElementById('quick_add_input');
            text = input.value.trim();
            if(!text) return;
            state.todos.push(createTaskObj(text, currentInput.priority, currentInput.category));
            input.value = '';
        } else {
            text = document.getElementById('goalInputName').value.trim();
            if(!text) return;
            state.goals[type].push(createTaskObj(text, currentInput.priority, currentInput.category));
            closeModal('addGoalModal');
        }
        save();
    }

    function createTaskObj(text, priority, category) {
        return { id: Date.now(), text, priority, category, completed: false, subtasks: [] };
    }

    function renderAll() {
        renderFilters(); renderCategories(); renderGraph();
        renderList('daily', state.todos);
        renderList('weekly', state.goals.weekly);
        renderList('monthly', state.goals.monthly);
        document.getElementById('todayCount').innerText = `${state.todos.length} tasks`;
    }

    function renderList(type, list) {
        const id = type==='daily'?'taskListDaily':(type==='weekly'?'taskListWeekly':'taskListMonthly');
        const container = document.getElementById(id);
        container.innerHTML = '';
        
        let filtered = list;
        if(state.activeFilter !== 'All') filtered = list.filter(t => t.category === state.activeFilter);
        
        // Sort: High Priority First, then ID
        const pVal = { high:3, med:2, low:1 };
        filtered.sort((a,b) => (pVal[b.priority]||0) - (pVal[a.priority]||0) || b.id - a.id);

        filtered.forEach(t => {
            const pColor = t.priority==='high'?'var(--danger)':t.priority==='med'?'var(--warning)':'var(--success)';
            const subDone = (t.subtasks||[]).filter(s=>s.completed).length;
            const subTotal = (t.subtasks||[]).length;
            const progress = subTotal>0 ? (subDone/subTotal)*100 : 0;
            
            let subHtml = '';
            (t.subtasks||[]).forEach((s, i) => {
                subHtml += `<div class="sub-item"><div class="sub-check ${s.completed?'checked':''}" onclick="toggleSub('${type}',${t.id},${i})"></div><div class="sub-text" onclick="editSub('${type}',${t.id},${i})">${s.text}</div><div class="sub-del" onclick="delSub('${type}',${t.id},${i})">√ó</div></div>`;
            });

            container.innerHTML += `
            <div class="task-card">
                <div class="task-main-row">
                    <div class="drag-handle">::</div>
                    <div class="task-check ${t.completed?'checked':''}" onclick="toggleTask('${type}', ${t.id})"></div>
                    <div class="task-body">
                        <div class="task-txt ${t.completed?'done':''}">${t.text}</div>
                        <div class="task-meta"><span class="p-dot" style="background:${pColor}"></span><span class="meta-tag">${t.category}</span>${subTotal>0 ? `<span class="meta-tag">${subDone}/${subTotal}</span>` : ''}</div>
                    </div>
                    <div class="task-actions">
                        <div class="action-icon" onclick="openEditTask(${t.id}, '${type}')">‚úé</div>
                        <div class="action-icon" onclick="toggleSubArea(${t.id})"><div class="chevron-icon" id="chev-${t.id}">‚ñº</div></div>
                        <div class="action-icon del" onclick="delTask('${type}', ${t.id})">üóë</div>
                    </div>
                </div>
                <div class="subtask-area" id="sub-${t.id}">
                    ${subTotal>0 ? `<div class="sub-progress"><div class="sub-bar" style="width:${progress}%"></div></div>` : ''}
                    <div id="sublist-${t.id}">${subHtml}</div>
                    <div class="sub-input-row"><div style="opacity:0.5">+</div><input type="text" class="sub-input-main" placeholder="Add step..." onkeydown="if(event.key==='Enter') addSub(event,'${type}',${t.id})"></div>
                </div>
            </div>`;
        });
    }

    // --- ACTIONS ---
    function toggleTask(type, id) {
        const list = type==='daily'?state.todos:state.goals[type];
        const t = list.find(x => x.id === id);
        if(t) { t.completed = !t.completed; if(t.completed) rainConfetti(); save(); }
    }
    
    function delTask(type, id) {
        if(!confirm("Delete?")) return;
        if(type==='daily') state.todos = state.todos.filter(x => x.id !== id);
        else state.goals[type] = state.goals[type].filter(x => x.id !== id);
        save();
    }

    function toggleSubArea(id) {
        document.getElementById(`sub-${id}`).classList.toggle('active');
        document.getElementById(`chev-${id}`).classList.toggle('rotated');
    }

    function addSub(e, type, id) {
        const txt = e.target.value.trim();
        if(!txt) return;
        const list = type==='daily'?state.todos:state.goals[type];
        const t = list.find(x => x.id === id);
        if(t) {
            if(!t.subtasks) t.subtasks = [];
            t.subtasks.push({ text: txt, completed: false });
            save();
            setTimeout(() => { toggleSubArea(id); document.getElementById(`sub-${id}`).classList.add('active'); }, 50);
        }
    }

    function toggleSub(type, pid, sid) {
        const list = type==='daily'?state.todos:state.goals[type];
        const t = list.find(x => x.id === pid);
        if(t && t.subtasks[sid]) {
            t.subtasks[sid].completed = !t.subtasks[sid].completed;
            save();
            setTimeout(() => { document.getElementById(`sub-${pid}`).classList.add('active'); }, 50);
        }
    }

    function editSub(type, pid, sid) {
        const newTxt = prompt("Rename step:");
        if(newTxt) {
            const list = type==='daily'?state.todos:state.goals[type];
            const t = list.find(x => x.id === pid);
            if(t && t.subtasks[sid]) { t.subtasks[sid].text = newTxt; save(); setTimeout(() => document.getElementById(`sub-${pid}`).classList.add('active'), 50); }
        }
    }

    function delSub(type, pid, sid) {
        const list = type==='daily'?state.todos:state.goals[type];
        const t = list.find(x => x.id === pid);
        if(t) { t.subtasks.splice(sid, 1); save(); setTimeout(() => document.getElementById(`sub-${pid}`).classList.add('active'), 50); }
    }

    // --- MODALS & EXTRAS ---
    function openEditTask(id, type) {
        const list = type==='daily'?state.todos:state.goals[type];
        const t = list.find(x => x.id === id);
        if(!t) return;
        editingTaskInfo = { id, type };
        document.getElementById('editTaskTitle').value = t.text;
        
        // Priority Chips
        const pc = document.getElementById('editPriorityChips'); pc.innerHTML = '';
        ['low','med','high'].forEach(p => pc.innerHTML += `<div class="chip p-${p} ${t.priority===p?'active':''}" onclick="setEditP('${p}')">${p}</div>`);
        
        // Cat Chips
        const cc = document.getElementById('editCategoryChips'); cc.innerHTML = '';
        state.categories.forEach(c => cc.innerHTML += `<div class="chip ${t.category===c?'active':''}" onclick="setEditC('${c}')">${c}</div>`);
        
        openModal('editTaskModal');
    }

    function setEditP(p) {
        const list = editingTaskInfo.type==='daily'?state.todos:state.goals[editingTaskInfo.type];
        const t = list.find(x => x.id === editingTaskInfo.id);
        if(t) { t.priority = p; openEditTask(editingTaskInfo.id, editingTaskInfo.type); }
    }
    
    function setEditC(c) {
        const list = editingTaskInfo.type==='daily'?state.todos:state.goals[editingTaskInfo.type];
        const t = list.find(x => x.id === editingTaskInfo.id);
        if(t) { t.category = c; openEditTask(editingTaskInfo.id, editingTaskInfo.type); }
    }

    function saveTaskEdit() {
        const list = editingTaskInfo.type==='daily'?state.todos:state.goals[editingTaskInfo.type];
        const t = list.find(x => x.id === editingTaskInfo.id);
        if(t) { t.text = document.getElementById('editTaskTitle').value; save(); closeModal('editTaskModal'); }
    }

    function renderFilters() {
        const c = document.getElementById('filterContainer'); c.innerHTML = '';
        ['All', ...state.categories].forEach(f => c.innerHTML += `<div class="filter-chip ${state.activeFilter===f?'active':''}" onclick="setFilter('${f}')">${f}</div>`);
    }
    function setFilter(f) { state.activeFilter = f; saveLocal(); }
    
    function renderCategories() {
        const c = document.getElementById('catContainer'); c.innerHTML = '';
        state.categories.forEach(cat => c.innerHTML += `<div class="chip ${currentInput.category===cat?'active':''}" onclick="setCat('${cat}')">${cat}</div>`);
    }
    function setCat(c) { currentInput.category = c; saveLocal(); }
    function setPriority(el, p) { currentInput.priority = p; document.querySelectorAll('.chip.p-low, .chip.p-med, .chip.p-high').forEach(x => x.classList.remove('active')); el.classList.add('active'); }

    function openCatManager() {
        const l = document.getElementById('catManagerList'); l.innerHTML = '';
        state.categories.forEach((c, i) => l.innerHTML += `<div class="cat-item-ui"><span>${c}</span><div style="cursor:pointer; color:var(--danger)" onclick="delCat(${i})">üóë</div></div>`);
        openModal('catManagerModal');
    }
    function promptAddCategory() { const n = prompt("Category Name:"); if(n && !state.categories.includes(n)) { state.categories.push(n); save(); openCatManager(); } }
    function delCat(i) { if(state.categories.length>1) { state.categories.splice(i,1); save(); openCatManager(); } else alert("Keep at least one"); }

    function renderGraph() {
        const c = document.getElementById('chartBars'); c.innerHTML = '';
        const limit = state.graphMode==='week'?7:30;
        let max = 1;
        for(let i=limit-1; i>=0; i--) {
            const d = new Date(); d.setDate(d.getDate()-i);
            const k = d.toLocaleDateString('en-CA');
            let done=0, total=0;
            if(k === new Date().toLocaleDateString('en-CA')) {
                total = state.todos.length; done = state.todos.filter(t=>t.completed).length;
            } else if(state.archives[k]) {
                done = (state.archives[k].completed||[]).length;
                total = done + (state.archives[k].missed||[]).length;
            }
            if(total>max) max=total;
            const h = (total/max)*100;
            const label = state.graphMode==='week' ? ['S','M','T','W','T','F','S'][d.getDay()] : d.getDate();
            c.innerHTML += `<div class="bar-group"><div class="bar-stack" style="height:${Math.max(h,5)}%"><div class="bar-segment done" style="height:${total>0?(done/total)*100:0}%"></div><div class="bar-segment missed" style="height:${total>0?((total-done)/total)*100:0}%"></div></div><div class="bar-label">${label}</div></div>`;
        }
    }
    function setGraph(m) { state.graphMode=m; document.getElementById('btn-week').classList.toggle('active', m==='week'); document.getElementById('btn-month').classList.toggle('active', m==='month'); saveLocal(); }

    function checkDayRollover() {
        const today = new Date().toLocaleDateString('en-CA');
        if(state.lastLoginDate && state.lastLoginDate !== today) {
            const incomplete = state.todos.filter(t => !t.completed);
            if(incomplete.length > 0) {
                pendingRolloverTasks = incomplete;
                state.todos = []; // Clear current
                if(!state.archives[state.lastLoginDate]) state.archives[state.lastLoginDate] = { completed:[], missed:[] };
                // Completed were already saved in history? Actually we need to archive completed now
                // Simplified: just handle incomplete rollover
                document.getElementById('rolloverCount').innerText = incomplete.length;
                openModal('rolloverModal');
            } else {
                state.todos = [];
            }
        }
        state.lastLoginDate = today;
        save();
    }
    function handleRollover(action) {
        const yKey = new Date(Date.now() - 86400000).toLocaleDateString('en-CA');
        if(!state.archives[yKey]) state.archives[yKey] = { completed:[], missed:[] };
        
        if(action === 'transfer') {
            state.todos = [...pendingRolloverTasks, ...state.todos];
        } else {
            state.archives[yKey].missed = pendingRolloverTasks;
        }
        closeModal('rolloverModal');
        save();
    }

    // --- UTILS ---
    function updateStatus(type, msg) {
        const d = document.getElementById('cloudDot');
        const t = document.getElementById('cloudText');
        d.className = 'status-dot '+type;
        t.innerText = msg;
    }
    function log(msg) { document.getElementById('syncLog').innerHTML = `<div>${msg}</div>` + document.getElementById('syncLog').innerHTML; }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function openAddGoalModal(t) { document.getElementById('btnSaveGoal').onclick = () => addTask(t); openModal('addGoalModal'); }
    function toggleTheme() { 
        state.theme = state.theme==='light'?'dark':'light'; 
        document.documentElement.setAttribute('data-theme', state.theme); 
        saveLocal(); 
    }
    function rainConfetti() {
        const colors = ['#ef4444', '#6366f1', '#10b981', '#f59e0b'];
        for(let i=0; i<30; i++) {
            const c = document.createElement('div'); c.className='confetti';
            c.style.left = Math.random()*100+'vw';
            c.style.background = colors[Math.floor(Math.random()*colors.length)];
            c.style.animation = `fall ${Math.random()*2+1}s linear`;
            document.body.appendChild(c);
            setTimeout(()=>c.remove(), 3000);
        }
    }
    if(!document.getElementById('c-style')) { const s = document.createElement('style'); s.id='c-style'; s.innerHTML='@keyframes fall { to { transform: translateY(100vh) rotate(360deg); } } .confetti { position:fixed; width:8px; height:8px; top:-10px; z-index:9999; }'; document.head.appendChild(s); }

    init();
</script>
</body>
</html>
